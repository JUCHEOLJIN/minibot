#!/usr/bin/env bash
set -euo pipefail

# ─── 경로 ─────────────────────────────────────────────────────────────────────
BOT_DIR="$HOME/.mini-bot/bot"
LOG_FILE="$HOME/.mini-bot/mini-bot.log"
PID_FILE="$HOME/.mini-bot/mini-bot.pid"
SKILLS_DIR="$HOME/.mini-bot/skills"

# ─── 색상 ─────────────────────────────────────────────────────────────────────
BOLD='\033[1m'
GREEN='\033[0;32m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
DIM='\033[2m'
NC='\033[0m'

ok()   { echo -e "  ${GREEN}✓${NC} $1"; }
warn() { echo -e "  ${YELLOW}⚠${NC}  $1"; }
fail() { echo -e "  ${RED}✗${NC} $1"; exit 1; }
info() { echo -e "  ${DIM}$1${NC}"; }

# ─── 설치 여부 확인 ────────────────────────────────────────────────────────────
check_installed() {
  if [ ! -d "$BOT_DIR" ]; then
    fail "mini-bot이 설치되어 있지 않습니다. 먼저 설치하세요:"
    echo ""
    echo "  curl -fsSL https://raw.githubusercontent.com/JUCHEOLJIN/minibot/main/install.sh | bash"
    echo ""
    exit 1
  fi
}

# ─── PID로 실행 중 여부 확인 ───────────────────────────────────────────────────
is_running() {
  [ -f "$PID_FILE" ] && kill -0 "$(cat "$PID_FILE")" 2>/dev/null
}

# ─── 명령어 ───────────────────────────────────────────────────────────────────

cmd_start() {
  check_installed

  local background=false
  for arg in "$@"; do
    [ "$arg" = "-d" ] || [ "$arg" = "--background" ] && background=true
  done

  if is_running; then
    warn "이미 실행 중입니다 (PID: $(cat "$PID_FILE"))"
    info "중지하려면: mini-bot stop"
    exit 0
  fi

  if [ "$background" = true ]; then
    echo -e "\n  ${BOLD}mini-bot${NC} 백그라운드 시작...\n"
    cd "$BOT_DIR"
    nohup caffeinate -i npm start >> "$LOG_FILE" 2>&1 &
    echo $! > "$PID_FILE"
    sleep 1
    if is_running; then
      ok "시작됨 (PID: $(cat "$PID_FILE"))"
      info "로그: mini-bot logs"
      info "중지: mini-bot stop"
    else
      fail "시작 실패. 로그를 확인하세요: mini-bot logs"
    fi
  else
    echo -e "\n  ${BOLD}mini-bot${NC} 시작...\n"
    cd "$BOT_DIR"
    caffeinate -i npm start
  fi
}

cmd_stop() {
  if ! is_running; then
    warn "실행 중이 아닙니다."
    rm -f "$PID_FILE"
    exit 0
  fi

  local pid
  pid=$(cat "$PID_FILE")
  kill "$pid"
  rm -f "$PID_FILE"
  ok "중지됨 (PID: $pid)"
}

cmd_restart() {
  echo -e "\n  ${BOLD}재시작 중...${NC}\n"
  cmd_stop 2>/dev/null || true
  sleep 1
  cmd_start --background
}

cmd_status() {
  echo ""
  echo -e "  ${BOLD}mini-bot 상태${NC}"
  echo ""

  if is_running; then
    local pid
    pid=$(cat "$PID_FILE")
    echo -e "  ${GREEN}●${NC} ${BOLD}실행 중${NC} (PID: $pid)"
  else
    echo -e "  ${RED}●${NC} ${BOLD}중지됨${NC}"
    rm -f "$PID_FILE"
  fi

  echo ""
  info "설치 위치: $BOT_DIR"
  info "스킬 위치: $SKILLS_DIR"
  info "로그 파일: $LOG_FILE"

  # 스킬 개수
  local skill_count=0
  if [ -d "$SKILLS_DIR" ]; then
    skill_count=$(find "$SKILLS_DIR" -name "SKILL.md" 2>/dev/null | wc -l | tr -d ' ')
  fi
  info "사용자 스킬: ${skill_count}개"
  echo ""
}

cmd_logs() {
  local lines="${1:-50}"

  if [ ! -f "$LOG_FILE" ]; then
    warn "로그 파일이 없습니다: $LOG_FILE"
    info "봇을 먼저 실행하세요: mini-bot start -d"
    exit 0
  fi

  echo -e "  ${DIM}로그: $LOG_FILE (Ctrl+C로 종료)${NC}\n"
  tail -n "$lines" -f "$LOG_FILE"
}

cmd_update() {
  check_installed
  echo -e "\n  ${BOLD}mini-bot 업데이트${NC}\n"

  echo -e "  ${DIM}git pull...${NC}"
  git -C "$BOT_DIR" pull

  echo -e "  ${DIM}npm install...${NC}"
  npm install --silent --prefix "$BOT_DIR"

  ok "업데이트 완료"

  if is_running; then
    echo ""
    warn "변경사항을 적용하려면 재시작이 필요합니다."
    info "재시작: mini-bot restart"
  fi
  echo ""
}

cmd_help() {
  echo ""
  echo -e "  ${BOLD}mini-bot${NC} ${DIM}— 확장형 Slack AI 봇${NC}"
  echo ""
  echo -e "  ${BOLD}사용법${NC}"
  echo -e "  ${CYAN}mini-bot <명령어> [옵션]${NC}"
  echo ""
  echo -e "  ${BOLD}명령어${NC}"
  echo -e "  ${CYAN}start${NC}              봇 시작 (포그라운드)"
  echo -e "  ${CYAN}start -d${NC}           봇 시작 (백그라운드)"
  echo -e "  ${CYAN}stop${NC}               봇 중지"
  echo -e "  ${CYAN}restart${NC}            봇 재시작 (백그라운드)"
  echo -e "  ${CYAN}status${NC}             실행 상태 확인"
  echo -e "  ${CYAN}logs${NC} [줄수]        로그 보기 (기본: 50줄, 실시간 추적)"
  echo -e "  ${CYAN}update${NC}             최신 버전으로 업데이트"
  echo ""
  echo -e "  ${BOLD}예시${NC}"
  echo -e "  ${DIM}mini-bot start -d     # 백그라운드로 시작${NC}"
  echo -e "  ${DIM}mini-bot logs         # 실시간 로그 확인${NC}"
  echo -e "  ${DIM}mini-bot restart      # 재시작${NC}"
  echo ""
}

# ─── 라우팅 ───────────────────────────────────────────────────────────────────
case "${1:-help}" in
  start)    shift; cmd_start "$@" ;;
  stop)     cmd_stop ;;
  restart)  cmd_restart ;;
  status)   cmd_status ;;
  logs)     shift; cmd_logs "${1:-50}" ;;
  update)   cmd_update ;;
  help|--help|-h) cmd_help ;;
  *)
    echo -e "  ${RED}알 수 없는 명령어: $1${NC}"
    cmd_help
    exit 1
    ;;
esac
